<!DOCTYPE html>
<html>

<head>
  <title>msfs2020-go/vfrmap</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="VFRMap">
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=">
  <link rel="stylesheet" href="/static/leaflet.css" />
  <link href="/static/tailwind.min.css" rel="stylesheet">
  <script src="/static/leaflet.js"></script>
  <script src="/static/leaflet.rotatedMarker.js"></script>
  <style type="text/css">
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    #map {
      background-color: gray;
      flex-grow: 1;
    }

    #load-map {
      position: absolute;
      bottom: 0;
      left: 0;
      z-index: 14;
      padding: 0.5em;
      color: black;
      background-color: red;
      font-size: 2em;
      font-weight: bold;
    }

    #teleport-popup p {
      padding: 0.2em;
      margin: 0;
      text-align: center;
    }

    #teleport-popup p label {
      padding-right: 0.2em;
    }

    .leaflet-top {
      margin-top: 1em;
    }

    .leaflet-bottom {
      margin-bottom: 3em;
    }

    .leaflet-right {
      margin-right: 1em;
    }
  </style>

  <script>
    "use strict";

    let hud;
    let map;
    let marker;
    let markerTeleport;
    let markerIcon;
    let popup;
    let ws;
    let plane_popup;
    let teleport_popup;
    let follow_plane = false;
    let last_report = {};
    let svgPlaneIconString =
      '<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" height="249.84" width="248.25" version="1.0"><metadata id="metadata9"/><path id="path5724" d="M 247.51404,152.40266 139.05781,71.800946 c 0.80268,-12.451845 1.32473,-40.256266 0.85468,-45.417599 -3.94034,-43.266462 -31.23018,-24.6301193 -31.48335,-5.320367 -0.0693,5.281361 -1.01502,32.598388 -1.10471,50.836622 L 0.2842717,154.37562 0,180.19575 l 110.50058,-50.48239 3.99332,80.29163 -32.042567,22.93816 -0.203845,16.89693 42.271772,-11.59566 0.008,0.1395 42.71311,10.91879 -0.50929,-16.88213 -32.45374,-22.39903 2.61132,-80.35205 111.35995,48.50611 -0.73494,-25.77295 z" fill-rule="evenodd" fill="__COLOR__"/></svg>'

    let planeIconBlack = L.icon({
      iconUrl: encodeURI("data:image/svg+xml," + svgPlaneIconString).replace("#", "%23").replace("__COLOR__",
        "black"),
      iconSize: [64, 64],
    });
    let planeIconWhite = L.icon({
      iconUrl: encodeURI("data:image/svg+xml," + svgPlaneIconString).replace("#", "%23").replace("__COLOR__",
        "white"),
      iconSize: [64, 64],
    });
    let planeIconGreen = L.icon({
      iconUrl: encodeURI("data:image/svg+xml," + svgPlaneIconString).replace("#", "%23").replace("__COLOR__",
        "green"),
      iconSize: [64, 64],
    });

    document.onkeyup = function (event) {
      if (event.key === "Escape") {
        toggle_follow();
      }
    }

    function open_in_google_maps() {
      var url = "https://www.google.com/maps/@" + last_report.latitude + "," + last_report.longitude + "," + map
        .getZoom() + "z"
      window.open(url, '_blank');
    }

    function set_teleport_marker(latlng) {
      markerTeleport.setLatLng(latlng);
      teleport_popup.gps.value = latlng.lat.toFixed(8) + "," + latlng.lng.toFixed(8);
      if (last_report.altitude) {
        teleport_popup.altitude.value = last_report.altitude;
      }
    }

    function updateMap(msg) {
      var pos = L.latLng(msg.latitude, msg.longitude);
      marker.setLatLng(pos);
      marker.setRotationAngle(msg.heading);

      plane_popup.pos.innerText = Number(pos.lat).toFixed(6) + "," + Number(pos.lng).toFixed(6);
      //plane_popup.gmap.innerHTML = "<a href=\"https://www.google.com/maps/@" + pos.lat + "," + pos.lng + "," + map.getZoom() + "z\">google maps</a>";

      if (follow_plane) {
        map.panTo(pos);
      }
    }

    function updateHUD(msg) {
      if (!hud) {
        return;
      }

      hud.altitude.innerText = msg.altitude;
      hud.heading.innerText = msg.heading;
      hud.airspeed.innerText = msg.airspeed;
      hud.vertical_speed.innerText = msg.vertical_speed;
      hud.flaps.innerText = msg.flaps;
      hud.trim.innerText = msg.trim;
      hud.rudder_trim.innerText = msg.rudder_trim;
    }

    ws = new WebSocket("ws://" + window.location.hostname + ":" + window.location.port + "/ws");
    ws.onopen = function () {
      //console.log("ws open");
    };
    ws.onclose = function () {
      //console.log("ws close");
    };
    ws.onmessage = function (e) {
      var msg = JSON.parse(e.data);
      //console.log("ws data", msg);
      last_report = msg;

      updateHUD(msg);

      if (map !== undefined) {
        updateMap(msg);
      }
    };

    function initMap() {
      var pos = L.latLng(52.4727, -1.7523);

      var osm = new L.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        minZoom: 2,
        format: "image/png",
        subdomains: ["a", "b", "c"]
      });
      var openaip_cached_basemap = new L.TileLayer(
        "http://{s}.tile.maps.openaip.net/geowebcache/service/tms/1.0.0/openaip_basemap@EPSG%3A900913@png/{z}/{x}/{y}.png", {
          maxZoom: 14,
          minZoom: 4,
          tms: true,
          //detectRetina: true,
          subdomains: "12",
          format: "image/png",
          transparent: true
        });
      var stamen_black_white = new L.TileLayer("http://{s}.tile.stamen.com/toner/{z}/{x}/{y}.png", {
        maxZoom: 18,
        minZoom: 2,
        format: "image/png",
        subdomains: ["a", "b", "c"]
      });
      var stamen_terrain = new L.TileLayer("http://{s}.tile.stamen.com/terrain/{z}/{x}/{y}.png", {
        maxZoom: 18,
        minZoom: 2,
        format: "image/png",
        subdomains: ["a", "b", "c"]
      });
      var stamen_water = new L.TileLayer("http://{s}.tile.stamen.com/watercolor/{z}/{x}/{y}.png", {
        maxZoom: 18,
        minZoom: 2,
        format: "image/png",
        subdomains: ["a", "b", "c"]
      });
      var carto_dark = new L.TileLayer("https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png", {
        maxZoom: 18,
        minZoom: 2,
        format: "image/png",
        subdomains: ["a", "b", "c"]
      });

      map = new L.Map("map", {
        layers: [osm],
        center: pos,
        zoom: 10,
        attributionControl: false
      });

      var attrib = L.control.attribution({
        position: "bottomleft"
      });
      attrib.addAttribution(
        "<a href=\"https://www.openstreetmap.org/copyright\" target=\"_blank\" style=\"\">OpenStreetMap</a>");
      attrib.addAttribution("<a href=\"https://www.openaip.net\" target=\"_blank\" style=\"\">openAIP</a>");
      attrib.addAttribution("<a href=\"http://maps.stamen.com\" target=\"_blank\" style=\"\">Stamen</a>");
      attrib.addAttribution("<a href=\"https://carto.com/\" target=\"_blank\" style=\"\">Carto</a>");

      attrib.addTo(map);

      var baseMaps = {
        "OpenStreetMap": osm,
        "Stamen Terrain": stamen_terrain,
        "Stamen Toner": stamen_black_white,
        "Stamen Water": stamen_water,
        "Carto Dark (Night Mode)": carto_dark,
      };

      var overlayMaps = {
        "Navigational Data": openaip_cached_basemap,
      };
      L.control.layers(baseMaps, overlayMaps).addTo(map);

      marker = L.marker(pos, {
        icon: planeIconBlack,
        rotationAngle: 0,
        rotationOrigin: "center",
      });
      marker.addTo(map);
      marker.bindPopup(L.popup({
        autoPan: false
      }).setLatLng(pos).setContent(plane_popup.main));

      var markerPos = L.latLng(0, 0);
      markerTeleport = L.marker(markerPos, {});
      markerTeleport.addTo(map);
      markerTeleport.bindPopup(L.popup({
        autoPan: false
      }).setContent(teleport_popup.main));
      set_teleport_marker(markerPos);

      map.on('dragstart', function (e) {
        follow_plane = true
        toggle_follow();
      });

      map.on('click', function (e) {
        set_teleport_marker(e.latlng);
      });

      map.on('baselayerchange', function (e) {
        if (e.name == "Carto Dark (Night Mode)") {
          marker.setIcon(planeIconWhite);
        } else if (e.name == "Stamen Toner") {
          marker.setIcon(planeIconGreen);
        } else {
          marker.setIcon(planeIconBlack);
        }
      });
    }

    function teleport_here() {
      //var pos = markerTeleport.getLatLng();
      var msg = JSON.stringify({
        "type": "teleport",
        "lat": parseFloat(teleport_popup.gps.value.split(",")[0]),
        "lng": parseFloat(teleport_popup.gps.value.split(",")[1]),
        "altitude": parseFloat(teleport_popup.altitude.value) + 0.5,
      });
      console.log(msg);
      ws.send(msg);
    }

    function toggle_follow() {
      if (follow_plane) {
        plane_popup.follow.innerText = "follow plane";
      } else {
        plane_popup.follow.innerText = "don't follow plane";
      }
      follow_plane = !follow_plane;
    }

    document.addEventListener("DOMContentLoaded", function (event) {
      plane_popup = {
        main: document.getElementById("plane-popup"),
        pos: document.getElementById("plane-popup-pos"),
        gmap: document.getElementById("plane-popup-gmap"),
        follow: document.getElementById("plane-popup-follow"),
      };
      teleport_popup = {
        main: document.getElementById("teleport-popup"),
        submit: document.getElementById("teleport-popup-submit"),
        gps: document.getElementById("teleport-popup-gps"),
        altitude: document.getElementById("teleport-popup-altitude"),
      };
      hud = {
        altitude: document.getElementById("altitude_value"),
        heading: document.getElementById("heading_value"),
        airspeed: document.getElementById("airspeed_value"),
        vertical_speed: document.getElementById("vertical_speed_value"),
        flaps: document.getElementById("flaps_value"),
        trim: document.getElementById("trim_value"),
        rudder_trim: document.getElementById("rudder_trim_value"),
      };

      toggle_follow();
      initMap();
    });
  </script>
  <script src="/static/alpine.min.js" defer></script>
</head>

<body x-data="{ showSettings: false, showInstruments: true, darkMode: true }">
  <div id="map" class="z-0"></div>
  <div id="settings-toggle" class="fixed right-0 m-6 mt-20 z-10">
    <button @click="showSettings = !showSettings"
      class="bg-white rounded-full p-2 shadow transition-colors duration-100 ease-in-out"
      :class="{ 'bg-gray-800': darkMode, 'text-gray-200': darkMode }">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        class="feather feather-settings">
        <circle cx="12" cy="12" r="3" />
        <path
          d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
      </svg>
    </button>
  </div>
  <div id="settings-menu" x-show="showSettings" class="absolute w-full h-full flex justify-center items-center -mt-12">
    <div class="w-1/2">
      <div class="bg-white rounded p-4 transition-colors duration-100 ease-in-out"
        :class="{ 'bg-gray-800': darkMode, 'text-gray-200': darkMode }">
        <div class="flex justify-between">
          <div>
            <h1 class="text-xl font-medium text-gray-400">Settings</h1>
          </div>
          <div>
            <button @click="showSettings = false"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" class="feather feather-x">
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
              </svg>
            </button>
          </div>
        </div>

        <label class="mt-4 block font-medium">
          <input x-model="showInstruments" class="mr-2 leading-tight h-4 w-4" type="checkbox">
          <span class="text-2xl">
            Display Instruments
          </span>
        </label>

        <label class="mt-4 block font-medium">
          <input x-model="darkMode" class="mr-2 leading-tight h-4 w-4" type="checkbox">
          <span class="text-2xl">
            Dark mode
          </span>
        </label>
      </div>
    </div>
  </div>
  <div id="instruments" x-show="showInstruments" class="
      bg-white
      px-8 py-4
      lg:fixed lg:bottom-0 lg:left-0 lg:z-10 lg:m-8 lg:rounded lg:shadow
      flex text-center font-medium gap-6 justify-around
      transition-colors duration-100 ease-in-out
    " :class="{ 'bg-gray-800': darkMode, 'text-gray-500': darkMode }">
    <div>
      <div>Air Speed</div>
      <div id="airspeed_value" class="font-bold font-mono text-2xl" :class="{ 'text-gray-200': darkMode }">0</div>
    </div>
    <div>
      <div>Altitude</div>
      <div id="altitude_value" class="font-bold font-mono text-2xl" :class="{ 'text-gray-200': darkMode }">0</div>
    </div>
    <div>
      <div>Heading</div>
      <div id="heading_value" class="font-bold font-mono text-2xl" :class="{ 'text-gray-200': darkMode }">0</div>
    </div>
    <div>
      <div>V.Speed</div>
      <div id="vertical_speed_value" class="font-bold font-mono text-2xl" :class="{ 'text-gray-200': darkMode }">0</div>
    </div>
    <div>
      <div>Flaps</div>
      <div id="flaps_value" class="font-bold font-mono text-2xl" :class="{ 'text-gray-200': darkMode }">0</div>
    </div>
    <div>
      <div>Trim</div>
      <div id="trim_value" class="font-bold font-mono text-2xl" :class="{ 'text-gray-200': darkMode }">0</div>
    </div>
    <div>
      <div>R.Trim</div>
      <div id="rudder_trim_value" class="font-bold font-mono text-2xl" :class="{ 'text-gray-200': darkMode }">0</div>
    </div>
  </div>
  <div style="display:none;">

    <div id="plane-popup">
      <p>
      <h3 id="plane-popup-pos"></h3>
      </p>
      <p><button id="plane-popup-gmap" onclick="open_in_google_maps();">open in google maps</button></p>
      <p><button id="plane-popup-follow" onclick="toggle_follow();"></button></p>
    </div>

    <div id="teleport-popup">
      <p><label for="teleport-popup-gps">GPS:</label><input type="text" id="teleport-popup-gps"></p>
      <p><label for="teleport-popup-alt">Altitude:</label><input type="text" id="teleport-popup-altitude"></p>
      <p><button type="button" id="teleport-popup-submit" onclick="teleport_here();">teleport</button></p>
    </div>

  </div>
</body>

</html>
